<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç”Ÿæ—¥å¿«ä¹ é™ˆè¯º</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            background: radial-gradient(circle at center, #1a0a0a 0%, #050505 100%);
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
        }

        #canvas-container {
            width: 100vw;
            height: 100vh;
        }

        /* è§†é¢‘æµé¢„è§ˆ - å·²éšè—ï¼Œä½†ä¿æŒå­˜åœ¨ä»¥ä¾›AIè¯†åˆ« */
        #video-preview {
            position: absolute;
            top: -9999px;
            left: -9999px;
            opacity: 0;
            width: 1px;
            height: 1px;
            pointer-events: none;
            z-index: -1;
        }

        /* é¡¶éƒ¨æ ‡é¢˜ - æ­£å¸¸çŠ¶æ€æ˜¾ç¤º */
        #ui-overlay {
            position: absolute;
            top: 10%;
            left: 50%;
            transform: translateX(-50%);
            pointer-events: none;
            z-index: 5;
            text-align: center;
            width: 100%;
            transition: opacity 1s;
        }

        h1 {
            color: white;
            font-size: 72px;
            margin: 0;
            text-shadow: 0 0 15px rgba(255, 255, 255, 0.6), 0 0 30px rgba(255, 105, 180, 0.4);
            letter-spacing: 12px;
            user-select: none;
        }

        /* å½©è›‹æ–‡å­—å®¹å™¨ - å±å¹•æ­£ä¸­å¤® */
        #egg-text {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.95);
            font-size: 26px;
            font-weight: 300;
            text-align: center;
            z-index: 20;
            pointer-events: none;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
            opacity: 0;
            width: 90%;
            line-height: 1.8;
            letter-spacing: 2px;
            font-family: "Songti SC", "SimSun", serif;
        }

        /* å·¦ä¸Šè§’æ‰‹åŠ¿æç¤ºè¯ - æ·¡ç°è‰²é£æ ¼ */
        #gesture-guide {
            position: absolute;
            top: 25px;
            left: 25px; /* ç§»å›å·¦ä¸Šè§’ */
            color: rgba(200, 200, 200, 0.8); /* æ·¡ç°è‰²æ–‡å­— */
            z-index: 10;
            /* æä½é€æ˜åº¦çš„èƒŒæ™¯ */
            background: rgba(255, 255, 255, 0.03); 
            backdrop-filter: blur(5px);
            padding: 15px 20px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            font-size: 13px;
            line-height: 1.7;
            transition: opacity 0.5s;
            pointer-events: none;
        }

        #gesture-guide b {
            color: rgba(230, 230, 230, 0.9); /* æ ‡é¢˜ç¨å¾®äº®ä¸€ç‚¹çš„ç°ç™½ */
            margin-right: 5px;
            font-weight: 500;
        }

        #status-dot {
            display: inline-block;
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: #666;
            margin-right: 6px;
            vertical-align: middle;
        }

        /* ----------------------------------
           åŠ è½½é¡µé¢æ ·å¼
           ---------------------------------- */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: #050505;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            z-index: 100;
            flex-direction: column;
            font-family: "Songti SC", "SimSun", serif;
        }

        .loading-content {
            text-align: center;
            opacity: 0;
            animation: fadeIn 1.5s ease-out forwards;
        }

        .loading-icon {
            font-size: 48px;
            margin-bottom: 24px;
            display: inline-block;
            animation: float 2s ease-in-out infinite;
        }

        .loading-screen h2 {
            font-weight: 300;
            letter-spacing: 4px;
            font-size: 24px;
            margin-bottom: 12px;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .loading-screen p {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.5);
            letter-spacing: 1px;
            font-weight: 300;
        }

        /* ----------------------------------
           ä¿¡å°/ä¿¡çº¸æ ·å¼
           ---------------------------------- */
        #letter-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 40; 
            display: flex;
            justify-content: center;
            align-items: center;
            pointer-events: none;
            opacity: 0;
            transition: opacity 2s ease-in-out;
        }

        #letter-paper {
            width: 85%;
            max-width: 650px; 
            background: rgba(20, 20, 25, 0.90);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 4px;
            
            padding: 30px 35px; 
            max-height: 85vh;
            
            overflow-y: auto; 
            
            color: rgba(230, 230, 230, 0.95);
            font-family: "Songti SC", "SimSun", "Times New Roman", serif;
            font-size: 14.5px;
            line-height: 1.6;
            letter-spacing: 0.5px;
            
            transform: translateY(30px);
            transition: transform 2s ease-out;
            position: relative;
            
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        
        #letter-paper::-webkit-scrollbar {
            display: none;
        }

        /* è£…é¥°æ€§çš„é‡‘è‰²è¾¹è§’ */
        #letter-paper::before {
            content: '';
            position: absolute;
            top: 10px; left: 10px; right: 10px; bottom: 10px;
            border: 1px solid rgba(255, 215, 0, 0.1);
            pointer-events: none;
        }

        #letter-content {
            white-space: pre-wrap;
            text-align: justify;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* æ¿€æ´»çŠ¶æ€ */
        #letter-overlay.active {
            opacity: 1;
            pointer-events: auto;
        }
        #letter-overlay.active #letter-paper {
            transform: translateY(0);
        }

    </style>
</head>
<body>
<!-- éŸ³ä¹è‡ªåŠ¨æ’­æ”¾ -->
<audio src="ä¸èƒ½è¯´çš„ç§˜å¯† - å‘¨æ°ä¼¦.mp3" autoplay="autoplay" loop></audio>

<!-- åŠ è½½ç•Œé¢ -->
<div id="loading" class="loading-screen">
    <div class="loading-content">
        <div class="loading-icon">ğŸ‚</div>
        <h2>âœ¨ æ­£åœ¨ä¸ºæ‚¨ç‚¹äº®èœ¡çƒ›...</h2>
        <p>è¯·å…è®¸ç›¸æœºæƒé™ï¼Œå¼€å¯æ‰‹åŠ¿é­”æ³•</p>
    </div>
</div>

<!-- å·¦ä¸Šè§’æ‰‹åŠ¿æç¤º - æ›´åŠ éšæ™¦ -->
<div id="gesture-guide">
    <div style="margin-bottom: 6px; padding-bottom: 4px; border-bottom: 1px solid rgba(255,255,255,0.1); font-weight: 600; color: rgba(240,240,240,0.9);">
        <span id="status-dot"></span> äº¤äº’æŒ‡å—
    </div>
    <div><b>æ—‹è½¬æ‰‹æŒï¼š</b> è§†è§’æ—‹è½¬</div>
    <div><b>äº”æŒ‡å¼ å¼€ï¼š</b> é è¿‘è›‹ç³•</div>
    <div><b>æ¡æ‹³æ‹‰è¿œï¼š</b> è¿œç¦»è›‹ç³•</div>
    <div style="margin-top: 8px; font-size: 11px; color: rgba(160, 160, 160, 0.6);">* è¯•è¯•é•œå¤´æ‹‰çš„å¾ˆè¿‘ä¸€å°ä¼š</div>
</div>

<!-- æ­£å¸¸æ ‡é¢˜ -->
<div id="ui-overlay">
    <h1 id="title">ç”Ÿæ—¥å¿«ä¹ é™ˆè¯º</h1>
</div>

<!-- å½©è›‹æ–‡å­— -->
<div id="egg-text"></div>

<!-- ä¿¡å°å±‚ -->
<div id="letter-overlay">
    <div id="letter-paper">
        <div id="letter-content"></div>
    </div>
</div>

<video id="video-preview" autoplay playsinline></video>
<div id="canvas-container"></div>

<!-- è„šæœ¬å¼•å…¥ -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
/**
 * é…ç½®ä¸çŠ¶æ€
 */
const CONFIG = {
    minDist: 15,
    maxDist: 85,
    explodeThreshold: 19,
    letterTriggerDist: 75, // è§¦å‘ä¿¡å°çš„è·ç¦»é˜ˆå€¼
    letterTriggerTime: 4000, // è§¦å‘ä¿¡å°éœ€è¦çš„æŒç»­æ—¶é—´(ms)
    particleCount: 28000,
    cakeColor: 0xffe066,
    creamColor: 0xffffff,
    strawberryColor: 0xff3355,
    candleColor: 0x00f2ff
};

let scene, camera, renderer, particles;
let explosionActive = false;
let targetCameraDist = 55;
let currentCameraAngle = 0;
let handPresent = false;

// ä¿¡å°ç›¸å…³çŠ¶æ€
let farAwayStartTime = 0;
let isLetterVisible = false;
let letterFullText = `To é™ˆè¯º

ç”Ÿæ—¥å¿«ä¹å‘€ï¼Œä¹Ÿè°¢è°¢ä½ æ„¿æ„çœ‹åˆ°è¿™é‡Œã€‚
ä¸‹é¢çš„å†…å®¹å¯èƒ½ä½ ä¸æ„¿æ„çœ‹ï¼Œä½†ä¹Ÿå¸Œæœ›ä½ èƒ½è€å¿ƒçœ‹ä¸‹å»ã€‚

ä½ çŸ¥é“ï¼Œæˆ‘å–œæ¬¢ä½ çš„ï¼Œé‚£æ ·çš„å–œæ¬¢ä¸æ˜¯å•çº¯çš„æœ‹å‹é—´çš„ã€‚
å³ä½¿ç°åœ¨ï¼Œæˆ‘è¿˜æ€»æ˜¯èƒ½æƒ³èµ·ï¼Œä½ é‚£å¤©çš„æ‹’ç»ï¼Œè¯´ç€æˆ‘ä»¬ä¸åˆé€‚ï¼Œä¹Ÿè®©æˆ‘å§‹ç»ˆæ˜¯æƒ³ä¸æ˜ç™½è‡ªå·±å·®åŠ²åœ¨å“ªé‡Œã€‚è¿™è®©æˆ‘çª’æ¯ï¼Œè®©æˆ‘å‹æŠ‘ï¼Œåˆä¸€ééåŠè¯´è‡ªå·±è¦å˜å¾—æ›´å¥½ï¼Œè¦ä¿æŒé€‚å½“çš„è·ç¦»ï¼Œè¦ä½“è´´è€å¿ƒï¼Œå“ªæ€•åªæ˜¯ä»¥æœ‹å‹çš„èº«ä»½ï¼Œä¹Ÿè¦ç¥æ„¿ç€è§è¯ç€ä½ é‡åˆ°æœ€çˆ±ä½ çš„äººï¼Œè§è¯ç€ä½ æœ‰äº†æœ€å¥½çš„ç”Ÿæ´»ã€‚

å…¶å®æˆ‘ä¸€ç›´ä¸çŸ¥é“ï¼Œä½ æ˜¯å¦‚ä½•çœ‹æˆ‘çš„ï¼Œå¹³æ·¡ï¼ŒåŒæ¶ï¼Œå–œæ¬¢ï¼Ÿæˆ‘ä¹Ÿä¸çŸ¥é“è‡ªå·±æ˜¯è‡ªä½œå¤šæƒ…ï¼Œè¿˜æ˜¯ååº”è¿Ÿé’ã€‚æˆ‘æ„Ÿè§‰ä½ æ€»æ˜¯ä¸æ„¿æ„æï¼Œåˆ»æ„é¿å¼€è¯é¢˜ï¼Œå¦‚æœå¯¹æˆ‘æ˜¯åŒæ¶å’Œæ— æ„Ÿï¼Œå¥½åƒä¹Ÿæ˜¯è¯´çš„é€šçš„ï¼›å¯æ˜¯ä½ ä¹Ÿæ€»ä¼šæ„¿æ„å¬æˆ‘çš„åæ§½ï¼Œå³ä½¿æˆ‘æœ‰æ—¶å€™çœŸçš„æˆ‘è‡ªå·±éƒ½å«Œæˆ‘è‡ªå·±çƒ¦ã€‚å¦‚æœä½ æœ‰æƒ³è¿‡æˆ‘ä»¬ä¹‹é—´æ˜¯å¯èƒ½çš„ï¼Œå¯åˆä¸ºä»€ä¹ˆä¸ç»™æˆ‘ä»»ä½•ä¿¡å·ï¼Œä¹Ÿæ€»ç¦»æˆ‘å¾ˆè¿œè®©æˆ‘å¤Ÿä¸ç€ã€‚

ä¹Ÿè®¸ä»å¤´åˆ°å°¾æˆ‘éƒ½æ˜¯é”™è¯¯çš„ï¼Œéƒ½æ˜¯æˆ‘è‡ªå·±çš„èƒ¡æ€ä¹±æƒ³ï¼Œä¹Ÿè®¸è¿™äº›æƒ…æ„Ÿä»ä¸€å¼€å§‹ä¹Ÿéƒ½ä¸å­˜åœ¨ã€‚æˆ‘ä¹Ÿæƒ³è¿‡å¾ˆå¤šæ¬¡æ”¾å¼ƒï¼Œåœ¨å¤‡å¿˜å½•é‡Œå†™ç€ä¸€ç« ç« æ¶æ¯’çš„è¯ï¼Œå’’éª‚è‡ªå·±å°ä¸‘ï¼Œè®©è‡ªå·±æ”¾å¼ƒå–œæ¬¢ä½ ã€‚å¯æ¯ä¸€æ¬¡ä¾ç„¶ä¼šè¢«ä½ çš„æ€§æ ¼ï¼Œä½ çš„æ ·è²Œå¸å¼•ï¼Œè¿˜æ˜¯ä¼šæƒ³å…³æ³¨ä½ ï¼Œåœ¨æ„ä½ ã€‚å¯èƒ½æˆ‘å°±æ˜¯ä¸æ“…é•¿æŠŠè¯è¯´æ­»ï¼Œæˆ‘è¿˜æƒ³åšæ›´å¤šçš„å°è¯•ï¼Œå°è¯•æˆ‘ä»¬ä¹‹é—´çš„å¯èƒ½ï¼Œåœ¨æˆ‘çš„å¿ƒè¿˜æ²¡å®Œå…¨ç©ºè½è½ä¹‹å‰ã€‚

æ‰€ä»¥ï¼Œå¦‚æœæˆ‘ä»¬ä¹‹é—´æ˜¯æœ‰å¯èƒ½çš„ï¼Œä½ ä¹Ÿè®¤çœŸæƒ³è¿‡äº†ï¼Œè¯·æœ‰æœºä¼šå’Œæˆ‘å¥½å¥½è°ˆä¸€è°ˆå§ã€‚æŠŠçœŸå®çš„é—®é¢˜å’Œä½ çš„é¡¾è™‘ä¸æˆ‘ä¸€èµ·æ¢è®¨ï¼Œä¹Ÿè¯·è®©æˆ‘æœ‰èµ„æ ¼ç»§ç»­å–œæ¬¢ä½ ï¼Œä¹Ÿåˆ«å†ä¸€ä¸ªäººå°±å¦å®šæˆ‘ä»¬æœªæ¥çš„å¯èƒ½å¥½å—ã€‚

è¿™ä¸‹ï¼Œæ˜¯çœŸçš„æ˜¯è¦è¯´å¯¹ä¸èµ·äº†ï¼Œè¯´äº†é‚£ä¹ˆå¤šå®³ä½ ç³Ÿå¿ƒçš„è¯ã€‚ç”Ÿæ°”ï¼Œéš¾è¿‡ï¼Œæ†æ¨æˆ‘ï¼Œæˆ‘éƒ½æ¥å—ï¼Œä¹Ÿæ„¿æ„å¥½å¥½èµ”ç¤¼é“æ­‰ã€‚

æ˜æ˜æ˜¯ä½ çš„ç”Ÿæ—¥ï¼Œä¸è¯¥è¯´è¿™äº›çš„ï¼Œåº”è¯¥é€ä¸Šæœ€è¯šæŒšçš„ç¥æ„¿ã€‚ç¥æ„¿ä½ é‡åˆ°è‰¯äººï¼Œå¹¸ç¦çš„åœ¨ä¸€èµ·ï¼Œæˆ‘åˆä¸ä¹æ„å“ˆå“ˆå“ˆã€‚åªå¥½ç¥ä½ æ¯å¤©éƒ½æ˜¯å¼€å¿ƒäº†ï¼Œç¥ä½ å¿ƒæƒ³äº‹æˆï¼

å–œæ¬¢ä½ çš„ å°é»„`;

// å½©è›‹çŠ¶æ€ç®¡ç†
let eggStartTime = null;
const eggTextEl = document.getElementById('egg-text');
const titleEl = document.getElementById('ui-overlay');
const guideEl = document.getElementById('gesture-guide');
const letterOverlay = document.getElementById('letter-overlay');
const letterContentEl = document.getElementById('letter-content');

// åˆå§‹åŒ–ä¿¡å°å†…å®¹
letterContentEl.innerText = letterFullText;

// å‰§æƒ…è„šæœ¬é…ç½® (é è¿‘æ—¶çš„å½©è›‹)
const eggScript = [
    { text: "æ²¡æƒ³åˆ°å·²ç»ä¸€å¹´å¤šäº†å‘¢", delayBefore: 5000, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "ä¸çŸ¥é“ï¼Œä»Šå¹´æˆ‘æ˜¯è®©ä½ å¼€å¿ƒæ›´å¤šï¼Œè¿˜æ˜¯éš¾è¿‡çš„æ›´å¤šå‘¢", delayBefore: 0, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "å“ˆå“ˆå“ˆï¼Œæ€»ä¹‹è°¢è°¢ä½ ä¸€ç›´ä»¥æ¥æ„¿æ„å€¾å¬æˆ‘è¯´çš„è¯", delayBefore: 0, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "å³ä½¿ï¼Œæ¯å¤©ä½ è‡ªå·±ä¹Ÿå¾ˆå—ä¼¤ï¼Œå¾ˆç´¯", delayBefore: 0, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "æˆ‘è¿˜ä¸€ç›´æƒ³æ”¶å›ä¹‹å‰ï¼Œå’Œä½ ä¸æ„‰å¿«æ—¶çš„æ°”è¯", delayBefore: 0, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "å…¶å®æˆ‘å½“æ—¶æ˜æ˜æ›´æƒ³è¯´", delayBefore: 0, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "æœ‰é‡åˆ°ä½ çœŸå¥½ï¼", delayBefore: 0, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "æˆ‘åªæ˜¯é‚£æ—¶å¤ªç—›äº†", delayBefore: 0, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "ä½†ä¸åæ‚”é‡åˆ°ä½ çš„ï¼", delayBefore: 0, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "æ²¡äº†ï¼Œæ²¡äº†ï¼Œä½ ä¸ä¼šè¿˜åœ¨ç­‰å…¶ä»–çš„å½©è›‹å§ï¼Ÿ", delayBefore: 6000, fadeIn: 2000, stay: 2000, fadeOut: 3000 },
    { text: "å¥½å§ï¼Œå¥½å§ï¼Œé‚£ä½ è¯•è¯•é•œå¤´æ‹‰åˆ°æœ€è¿œç­‰ç­‰çœ‹", delayBefore: 4000, fadeIn: 2000, stay: 999999, fadeOut: 0 } 
];

// é¢„è®¡ç®—æ—¶é—´è½´
let timeline = [];
function buildTimeline() {
    timeline = [];
    let currentTime = 0;

    eggScript.forEach(item => {
        currentTime += item.delayBefore;
        const start = currentTime;
        const fullyVisible = start + item.fadeIn;
        const startFadeOut = fullyVisible + item.stay;
        const end = startFadeOut + item.fadeOut;
        
        timeline.push({
            text: item.text,
            start: start,
            fullyVisible: fullyVisible,
            startFadeOut: startFadeOut,
            end: end,
            fadeInDuration: item.fadeIn,
            fadeOutDuration: item.fadeOut
        });

        currentTime = end;
    });
}
buildTimeline();

/**
 * Three.js åˆå§‹åŒ–
 */
const vertexShader = `
    attribute float size;
    attribute vec3 color;
    attribute vec3 velocity;
    varying vec3 vColor;
    uniform float time;
    uniform float explode;

    void main() {
        vColor = color;
        vec3 pos = position;

        if (explode > 0.0) {
            pos += velocity * explode * 3.5;
        }

        float pulse = 1.0 + 0.12 * sin(time * 3.5 + position.y * 0.5);
        vec4 mvPosition = modelViewMatrix * vec4(pos, 1.0);
        gl_PointSize = size * (450.0 / -mvPosition.z) * pulse;
        gl_Position = projectionMatrix * mvPosition;
    }
`;

const fragmentShader = `
    varying vec3 vColor;
    void main() {
        float dist = distance(gl_PointCoord, vec2(0.5));
        if (dist > 0.5) discard;
        float strength = pow(1.0 - (dist * 2.0), 1.6);
        gl_FragColor = vec4(vColor, strength);
    }
`;

function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(65, window.innerWidth / window.innerHeight, 0.1, 1000);
    
    renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
    document.getElementById('canvas-container').appendChild(renderer.domElement);

    createCakeParticles();

    window.addEventListener('resize', () => {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    });
}

function createCakeParticles() {
    const geometry = new THREE.BufferGeometry();
    const positions = [];
    const colors = [];
    const sizes = [];
    const velocities = [];

    const addParticle = (x, y, z, colorHex, size) => {
        positions.push(x, y, z);
        const c = new THREE.Color(colorHex);
        colors.push(c.r, c.g, c.b);
        sizes.push(size);
        const v = new THREE.Vector3(x, y + 2, z).normalize().multiplyScalar(Math.random() * 6 + 3);
        velocities.push(v.x, v.y, v.z);
    };

    const createCylinder = (radius, height, baseY, color, count, isCream) => {
        for (let i = 0; i < count; i++) {
            const r = Math.sqrt(Math.random()) * radius;
            const theta = Math.random() * Math.PI * 2;
            const x = r * Math.cos(theta);
            const z = r * Math.sin(theta);
            const y = baseY + Math.random() * height;
            
            let finalColor = color;
            if (isCream || r > radius * 0.9 || y > baseY + height * 0.92) {
                finalColor = CONFIG.creamColor;
            }
            addParticle(x, y, z, finalColor, Math.random() * 0.7 + 0.4);
        }
    };

    createCylinder(12, 7, -7, CONFIG.cakeColor, 15000, false);
    createCylinder(8, 6, 0, CONFIG.cakeColor, 10000, false);

    for (let j = 0; j < 10; j++) {
        const angle = (j / 10) * Math.PI * 2;
        const rx = 10 * Math.cos(angle);
        const rz = 10 * Math.sin(angle);
        for(let i=0; i<120; i++) {
            addParticle(
                rx + (Math.random()-0.5)*2, 
                0.5 + (Math.random()-0.5)*2, 
                rz + (Math.random()-0.5)*2, 
                CONFIG.strawberryColor, 0.5
            );
        }
    }

    for (let i = 0; i < 600; i++) {
        const x = (Math.random() - 0.5) * 0.6;
        const z = (Math.random() - 0.5) * 0.6;
        const y = 6 + Math.random() * 5;
        const isFlame = y > 10;
        addParticle(x, y, z, isFlame ? 0xffaa00 : CONFIG.candleColor, isFlame ? 0.8 : 0.4);
    }

    geometry.setAttribute('position', new THREE.Float32BufferAttribute(positions, 3));
    geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));
    geometry.setAttribute('size', new THREE.Float32BufferAttribute(sizes, 1));
    geometry.setAttribute('velocity', new THREE.Float32BufferAttribute(velocities, 3));

    const material = new THREE.ShaderMaterial({
        uniforms: {
            time: { value: 0 },
            explode: { value: 0 }
        },
        vertexShader,
        fragmentShader,
        transparent: true,
        blending: THREE.AdditiveBlending,
        depthWrite: false
    });

    particles = new THREE.Points(geometry, material);
    scene.add(particles);
}

/**
 * æ‰‹åŠ¿å¤„ç†
 */
const videoElement = document.getElementById('video-preview');
const statusDot = document.getElementById('status-dot');

function onResults(results) {
    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
        handPresent = true;
        statusDot.style.background = "#00ff00";
        const landmarks = results.multiHandLandmarks[0];
        
        const p0 = landmarks[0];
        const p9 = landmarks[9];
        const angle = Math.atan2(p9.y - p0.y, p9.x - p0.x) + Math.PI/2;
        currentCameraAngle = -angle * 2.5;

        const fingerTips = [8, 12, 16, 20];
        let totalDist = 0;
        fingerTips.forEach(tip => {
            totalDist += Math.hypot(landmarks[tip].x - p0.x, landmarks[tip].y - p0.y);
        });
        
        const handOpenFactor = totalDist / 4;
        const isFist = handOpenFactor < 0.18;
        const isOpen = handOpenFactor > 0.35;

        const handScale = Math.hypot(landmarks[5].x - landmarks[17].x, landmarks[5].y - landmarks[17].y);
        
        if (isFist) {
            const moveTarget = (0.4 - handScale) * 120 + 40;
            targetCameraDist += (moveTarget - targetCameraDist) * 0.05;
        } else if (isOpen) {
            const moveTarget = (handScale - 0.1) * -160 + 50;
            targetCameraDist += (moveTarget - targetCameraDist) * 0.1;
        }

        targetCameraDist = Math.max(CONFIG.minDist, Math.min(CONFIG.maxDist, targetCameraDist));
    } else {
        handPresent = false;
        statusDot.style.background = "#ff3300";
    }
}

const hands = new Hands({
    locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`
});

hands.setOptions({
    maxNumHands: 1,
    modelComplexity: 1,
    minDetectionConfidence: 0.6,
    minTrackingConfidence: 0.6
});
hands.onResults(onResults);

const cameraMP = new Camera(videoElement, {
    onFrame: async () => {
        await hands.send({ image: videoElement });
    },
    width: 640,
    height: 480
});

/**
 * åŠ¨ç”»å¾ªç¯ä¸å½©è›‹é€»è¾‘
 */
let lastTime = 0;
let explosionFactor = 0;

function updateEggText(elapsed) {
    let activeItem = null;
    for (let item of timeline) {
        if (elapsed >= item.start && elapsed < item.end) {
            activeItem = item;
            break;
        }
        if (item.end > 900000 && elapsed >= item.start) {
            activeItem = item;
            break;
        }
    }

    if (activeItem) {
        eggTextEl.innerText = activeItem.text;
        let opacity = 0;
        if (elapsed < activeItem.fullyVisible) {
            opacity = (elapsed - activeItem.start) / activeItem.fadeInDuration;
        } else if (elapsed < activeItem.startFadeOut) {
            opacity = 1;
        } else {
            if (activeItem.fadeOutDuration === 0) opacity = 1;
            else opacity = 1 - (elapsed - activeItem.startFadeOut) / activeItem.fadeOutDuration;
        }
        eggTextEl.style.opacity = Math.max(0, Math.min(1, opacity));
    } else {
        eggTextEl.style.opacity = 0;
    }
}

function updateLetterLogic(time) {
    // æ£€æŸ¥è·ç¦»æ˜¯å¦æ»¡è¶³ä¿¡å°è§¦å‘æ¡ä»¶ (æ‹‰å¾—å¾ˆè¿œ)
    if (targetCameraDist > CONFIG.letterTriggerDist) {
        if (farAwayStartTime === 0) {
            farAwayStartTime = time;
        } else if (time - farAwayStartTime > CONFIG.letterTriggerTime) {
            // æ»¡è¶³è§¦å‘æ¡ä»¶
            if (!isLetterVisible) {
                isLetterVisible = true;
                letterOverlay.classList.add('active');
                titleEl.style.opacity = 0; // éšè—æ ‡é¢˜
            }
        }
    } else {
        // å¦‚æœè·ç¦»æ‹‰è¿‘äº†ï¼Œé‡ç½®è®¡æ—¶å™¨å¹¶éšè—ä¿¡å°
        farAwayStartTime = 0;
        if (isLetterVisible) {
            isLetterVisible = false;
            letterOverlay.classList.remove('active');
            titleEl.style.opacity = 1; // æ¢å¤æ ‡é¢˜
        }
    }
}

function animate(time) {
    requestAnimationFrame(animate);
    const dt = time - lastTime;
    lastTime = time;

    const lerpSpeed = 0.06;
    const camX = Math.sin(currentCameraAngle) * targetCameraDist;
    const camZ = Math.cos(currentCameraAngle) * targetCameraDist;
    const camY = 6 + (targetCameraDist * 0.15);

    camera.position.x += (camX - camera.position.x) * lerpSpeed;
    camera.position.z += (camZ - camera.position.z) * lerpSpeed;
    camera.position.y += (camY - camera.position.y) * lerpSpeed;
    camera.lookAt(0, -2, 0);

    // é€»è¾‘åˆ¤å®šåŒºåˆ†
    const isExploding = targetCameraDist < CONFIG.explodeThreshold;
    
    // --- 1. é è¿‘çˆ†ç‚¸/çŸ­å½©è›‹é€»è¾‘ ---
    if (isExploding) {
        if (!explosionActive) {
            explosionActive = true;
            eggStartTime = time; 
            titleEl.style.opacity = 0;
            guideEl.style.opacity = 0;
        }
        explosionFactor += (1.0 - explosionFactor) * 0.08;
        const eggElapsed = time - eggStartTime;
        updateEggText(eggElapsed);
    } else {
        if (explosionActive) {
            explosionActive = false;
            eggStartTime = null;
            // å¦‚æœæ­¤æ—¶ä¿¡å°ä¹Ÿæ²¡æ˜¾ç¤ºï¼Œæ‰æ¢å¤æ ‡é¢˜
            if (!isLetterVisible) {
                titleEl.style.opacity = 1;
                guideEl.style.opacity = 1;
            }
            eggTextEl.style.opacity = 0;
            eggTextEl.innerText = "";
        }
        explosionFactor += (0.0 - explosionFactor) * 0.12;
    }

    // --- 2. è¿œç¦»/é•¿ä¿¡å°é€»è¾‘ ---
    updateLetterLogic(time);

    // --- 3. ç²’å­æ¸²æŸ“ ---
    if (particles) {
        particles.material.uniforms.time.value = time * 0.001;
        particles.material.uniforms.explode.value = explosionFactor;
        
        // æ—‹è½¬é€»è¾‘ï¼šä¿¡å°å‡ºç°æ—¶ï¼ŒèƒŒæ™¯ä¹Ÿä¾ç„¶ç¼“æ…¢æ—‹è½¬
        if (explosionActive) {
            particles.rotation.y += 0.0005; 
        } else if (!handPresent) {
            // æ²¡æœ‰æ‰‹åŠ¿æ—¶è‡ªåŠ¨æ—‹è½¬
            particles.rotation.y += 0.003;  
        } else {
            // æ‰‹åŠ¿æ§åˆ¶æ—¶ï¼Œå¦‚æœä¿¡å°å‡ºç°äº†ï¼Œä¹Ÿå¯ä»¥ä¿æŒä¸€ç‚¹ç‚¹è‡ªè½¬å¢åŠ æ°›å›´
            if (isLetterVisible) {
                particles.rotation.y += 0.001;
            }
        }
    }

    renderer.render(scene, camera);
}

window.onload = () => {
    initThree();
    cameraMP.start().then(() => {
        document.getElementById('loading').style.display = 'none';
        animate(0);
    });
};
</script>
</body>
</html>